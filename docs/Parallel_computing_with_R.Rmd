---
title: "The Good, The Bad, The Ugly with R"
knit: (function(input_file, encoding) {
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), 'index.html'))})
author: "Ehsan Jahanpour"
date: "12/08/2019"
output:
  html_document: 
    toc: true
    toc_float: true
  pdf_document: default
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(doParallel)
library(foreach)
library(reshape2)
```

## Introduction

Once upon a time in Hollywood, it was adequate for statisticians, data analysts, physicians, ... to

a. pull up the Rstudio, 
b. `write.csv()` the file, 
c. for loop into the files and 
d. apply statistical analytics and draw inference from data and experiments. 

The world is expanding and so the programming languages and methods. The good methodology in the past could get very ugly nowadays without us noticing that. We need to understand the nature of the problem, data available, and types of studies and select the best tool to solve that.  

"The amount of data being generated and stored is growing exponentially", this is the phrase we keep hearing. The data/information explosion has brought a lot of challenges in processing large amount of data and made our "fun" process of data analysis into an "OK" daily task. If you feel the same, you are not alone and that is why I am writing this blog. We need to change our programming habbits to be able to "Make Data Analysis Great Again!". I will try my best to explain why, when, and how to apply parallel computing. Let's get back to the topic:

![](../images/data_explosion.png)


## Why & When

Following the cinematic schema of the blog, I would like to use movie data to illustrate how parallelization can be used to make our lives less dramatic. The dataset I am using here is downloaded from [CMU Movie Summary Corpus](http://www.cs.cmu.edu/~ark/personas/data/MovieSummaries.tar.gz). For more information about the dataset please visit the page. The plot summary of the movies are stored in `plto_summaries.txt` file. I have only using the first 1000 summaries from that file:

```{r movies}
# sample = read.csv('../sample_plot_summmary.csv'
plot_summary <- read.table('../data/plot_summaries.txt', sep = '\t')
row_number <- seq(100, nrow(plot_summary)/10, by= 100)

```

```{r function}
text_features <- function(text){
  words_to_search <- c('johannesburg', 'world war')
  reg_word <- paste0(words_to_search, collapse = '|')
  word_exists <- grepl(reg_word, tolower(text))
  word_count <- sapply(strsplit(tolower(text), " "), length)
  return(c(word_exists, word_count))
}
```

```{r ugly}
single_loop_script <- function(sample) {
  return(system.time(
    for (i in 1:nrow(sample)) {
      sample[i, c('keyword', 'word_counts')] <- text_features(sample[i, 2])
    }
  ))
}
``` 

```{r bad}
mapply_script <- function(sample) {
  return(
    system.time(
      sample[, c('keyword', 'word_count')] <- mapply(text_features, sample[, 2])
  ))
}

``` 

```{r good}
num_cores <- parallel::detectCores() 
parallel_loop_script <- function(sample) {
  return(system.time({
    registerDoParallel(num_cores)
    foreach (i = 1:nrow(sample)) %dopar% {
      sample[i, c('keyword_good', 'word_count')] <- text_features(sample[i, 2])
    }
  }
  ))
}
``` 

```{r timeline}
# If foreach is netter let's change the behavior and use it while we can
runtime_list <- foreach (i = 1:length(row_number)) %dopar%
{
  for_single <- single_loop_script(plot_summary[1:row_number[i],])
  apply_method <- mapply_script(plot_summary[1:row_number[i],])
  for_parrallel <- parallel_loop_script(plot_summary[1:row_number[i],])
  return(list(i, for_single[[3]], apply_method[[3]], for_parrallel[[3]]))
}
```


```{r visualization}
# change the list of lists to dataframe
runtime_df <- do.call(rbind.data.frame, runtime_list)
names(runtime_df) <- c('index', 'single_loop', 'mapply', 'parallel_loop')

# need to melt the dataframe to be able to line plot them
melted <- reshape2::melt(runtime_df, measure.vars = c('single_loop', 'mapply', 'parallel_loop'))
ggplot(melted, aes(index, value, color = variable)) +
  geom_line(aes(group = paste0(variable)))
# x <- 1:length(run_time1)
# plot(x, run_time1, type = 'l', col = 'blue')
# lines(x, run_time2, type = 'l', col = 'red')
# lines(x, run_time3, type = 'l', col = 'green')
# legend(x=1.5, y=1.5, legend=c("for", "mapply", 'dopar'), col = c('blue', 'red', 'green'), lty=1)

```
### Why parallel computing?

```{r cars}

```

### When to Parallelize?


## Parallel packages in R